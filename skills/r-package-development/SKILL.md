---
name: r-package-development
description: |
  This skill should be used when the user is working on R package development, including tasks like "create an R package", "add a function to my package", "write tests", "document functions", "run devtools::check()", "fix R CMD check errors", "set up testthat", "add roxygen documentation", "configure DESCRIPTION", or needs guidance on devtools workflows, testthat patterns, roxygen2 tags, usethis helpers, or monorepo package organization.
version: 1.0.0
---

# R Package Development

Guidance for developing R packages using devtools, testthat, roxygen2, and usethis.

## Core Workflow

The standard package development cycle:

```r
# Load package for interactive development
devtools::load_all()   # Ctrl+Shift+L in RStudio

# Generate documentation from roxygen comments
devtools::document()   # Ctrl+Shift+D

# Run test suite
devtools::test()       # Ctrl+Shift+T

# Full R CMD check
devtools::check()      # Ctrl+Shift+E
```

## Package Structure

Standard layout:

```
mypackage/
├── DESCRIPTION        # Package metadata
├── NAMESPACE          # Generated by roxygen2
├── R/                 # R source files
│   ├── mypackage-package.R  # Package-level docs
│   └── functions.R
├── man/               # Generated documentation
├── tests/
│   ├── testthat.R     # Test runner
│   └── testthat/
│       └── test-functions.R
├── inst/              # Installed files
├── data/              # Package data
└── vignettes/         # Long-form documentation
```

## DESCRIPTION File

Essential fields:

```
Package: mypackage
Title: What the Package Does (One Line)
Version: 0.1.0
Authors@R: person("First", "Last", email = "email@example.com", role = c("aut", "cre"))
Description: What the package does. Should be one paragraph of 2-4 sentences.
License: MIT + file LICENSE
Encoding: UTF-8
Roxygen: list(markdown = TRUE)
RoxygenNote: 7.3.0
Imports:
    dplyr,
    rlang
Suggests:
    testthat (>= 3.0.0)
Config/testthat/edition: 3
```

## testthat 3 Patterns

### describe/it Style (Recommended)

```r
describe("function_name()", {
  it("returns expected output for typical input", {
    result <- function_name(x = 1, y = 2)
    expect_equal(result, 3)
  })

  it("handles NULL input gracefully", {
    expect_null(function_name(NULL))
  })

  it("errors on invalid input", {
    expect_error(
      function_name("not a number"),
      class = "mypackage_error"
    )
  })
})
```

### test_that Style

```r
test_that("function_name returns sum of inputs", {
  expect_equal(function_name(1, 2), 3)
  expect_equal(function_name(0, 0), 0)
})

test_that("function_name errors on bad input", {
  expect_error(function_name("a"))
})
```

### Snapshot Tests

For complex outputs that are hard to specify:

```r
test_that("summary output matches snapshot", {
  result <- create_summary(data)
  expect_snapshot(print(result))
})

test_that("plot renders correctly", {
  expect_snapshot_file(
    save_plot(my_plot, "test-plot.png"),
    "test-plot.png"
  )
})
```

Update snapshots: `testthat::snapshot_accept()`

### Test Fixtures

For shared test data:

```r
# tests/testthat/helper.R - loaded before tests
test_data <- data.frame(x = 1:3, y = letters[1:3])

# tests/testthat/fixtures/sample.csv - static files
# Read in tests with:
test_path("fixtures", "sample.csv")
```

## roxygen2 Documentation

### Function Documentation

```r
#' Calculate the mean of a numeric vector
#'
#' Computes the arithmetic mean, with options for handling missing values.
#'
#' @param x A numeric vector.
#' @param na.rm Logical. Should `NA` values be removed? (default: `FALSE`)
#' @param trim Fraction of observations to trim from each end (default: `0`).
#'
#' @return A single numeric value representing the mean.
#'
#' @export
#' @examples
#' my_mean(1:10)
#' my_mean(c(1, 2, NA), na.rm = TRUE)
#'
#' @seealso [stats::mean()] for the base R version
my_mean <- function(x, na.rm = FALSE, trim = 0) {
  mean(x, na.rm = na.rm, trim = trim)
}
```

### Common Tags

| Tag | Purpose |
|-----|---------|
| `@param` | Document function parameter |
| `@return` | Describe return value |
| `@export` | Add to NAMESPACE (user-facing) |
| `@keywords internal` | Internal function |
| `@examples` | Runnable examples |
| `@inheritParams` | Reuse param docs from another function |
| `@family` | Group related functions |
| `@seealso` | Link to related functions |

### Package Documentation

In `R/mypackage-package.R`:

```r
#' @keywords internal
"_PACKAGE"

#' @importFrom rlang .data
#' @importFrom dplyr %>%
NULL
```

## usethis Helpers

Common setup commands:

```r
# Initial setup
usethis::create_package("path/to/mypackage")
usethis::use_mit_license()
usethis::use_testthat()
usethis::use_readme_rmd()

# Add dependencies
usethis::use_package("dplyr")
usethis::use_package("rlang", type = "Imports")
usethis::use_dev_package("testthat", type = "Suggests")

# Create files
usethis::use_r("new-function")
usethis::use_test("new-function")
usethis::use_vignette("getting-started")

# Git and GitHub
usethis::use_git()
usethis::use_github()
usethis::use_github_action_check_standard()
```

## Monorepo Patterns

When packages live alongside analysis code:

```
project/
├── packages/
│   ├── pkgA/
│   │   ├── DESCRIPTION
│   │   └── R/
│   └── pkgB/
│       ├── DESCRIPTION
│       └── R/
├── analysis/
│   ├── _targets.R
│   └── reports/
└── renv.lock
```

Development workflow:

```r
# Load a specific package
devtools::load_all("packages/pkgA")

# Test specific package
devtools::test("packages/pkgB")

# Check specific package
devtools::check("packages/pkgA")
```

## Common R CMD check Issues

### No visible binding for global variable

```r
# Solution 1: Use .data pronoun
dplyr::filter(df, .data$column == value)

# Solution 2: Declare in package
utils::globalVariables(c("column"))
```

### Undocumented arguments

Add `@param` for all function arguments, even `...`:

```r
#' @param ... Additional arguments passed to [base_function()].
```

### Missing imports

Add to DESCRIPTION and use explicit namespacing:

```r
#' @importFrom dplyr filter select
```

Or use `pkg::function()` syntax throughout code.

## References

For detailed patterns, see:
- `references/testthat-patterns.md` - Advanced testing patterns
- `references/roxygen-tags.md` - Complete tag reference
